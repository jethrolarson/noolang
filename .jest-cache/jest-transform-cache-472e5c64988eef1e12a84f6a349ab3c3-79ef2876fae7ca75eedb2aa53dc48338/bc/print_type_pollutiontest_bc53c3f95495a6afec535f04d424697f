3c3a83baafff3e49c60bf686a1ed1efa
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const lexer_1 = require("../src/lexer");
const parser_1 = require("../src/parser/parser");
const typer_1 = require("../src/typer");
const type_operations_1 = require("../src/typer/type-operations");
const builtins_1 = require("../src/typer/builtins");
describe('Polymorphic Function Type Pollution', () => {
    test('print should remain polymorphic between uses', () => {
        // Initialize fresh type state for each test
        let state = (0, type_operations_1.createTypeState)();
        state = (0, builtins_1.initializeBuiltins)(state);
        // First, use print with integer
        const lexer1 = new lexer_1.Lexer('print 1');
        const tokens1 = lexer1.tokenize();
        const program1 = (0, parser_1.parse)(tokens1);
        const result1 = (0, typer_1.typeAndDecorate)(program1, state);
        state = result1.state;
        // Print should work with Int - check if this succeeds
        expect(() => result1).not.toThrow();
        // Now use print with string - this should also work
        const lexer2 = new lexer_1.Lexer('print "hello"');
        const tokens2 = lexer2.tokenize();
        const program2 = (0, parser_1.parse)(tokens2);
        // This should not throw - print should be polymorphic
        expect(() => {
            const result2 = (0, typer_1.typeAndDecorate)(program2, state);
        }).not.toThrow();
    });
    test('simulate REPL behavior - alternating print types', () => {
        // Simulate REPL state persistence
        let state = (0, type_operations_1.createTypeState)();
        state = (0, builtins_1.initializeBuiltins)(state);
        // First REPL input: print 1
        const lexer1 = new lexer_1.Lexer('print 1');
        const tokens1 = lexer1.tokenize();
        const program1 = (0, parser_1.parse)(tokens1);
        const result1 = (0, typer_1.typeAndDecorate)(program1, state);
        state = result1.state; // Persist state like REPL does
        // Second REPL input: print "hi" - this should work
        const lexer2 = new lexer_1.Lexer('print "hi"');
        const tokens2 = lexer2.tokenize();
        const program2 = (0, parser_1.parse)(tokens2);
        // This is where the bug manifests - print gets "stuck" on Int type
        expect(() => {
            const result2 = (0, typer_1.typeAndDecorate)(program2, state);
            state = result2.state;
        }).not.toThrow();
        // Third REPL input: print 42 - should work again
        const lexer3 = new lexer_1.Lexer('print 42');
        const tokens3 = lexer3.tokenize();
        const program3 = (0, parser_1.parse)(tokens3);
        expect(() => {
            const result3 = (0, typer_1.typeAndDecorate)(program3, state);
        }).not.toThrow();
    });
    test('other polymorphic functions should not have type pollution', () => {
        let state = (0, type_operations_1.createTypeState)();
        state = (0, builtins_1.initializeBuiltins)(state);
        // Test == operator with different types
        const eq1 = (0, typer_1.typeAndDecorate)((0, parser_1.parse)(new lexer_1.Lexer('1 == 1').tokenize()), state);
        state = eq1.state;
        expect(() => {
            const eq2 = (0, typer_1.typeAndDecorate)((0, parser_1.parse)(new lexer_1.Lexer('"a" == "b"').tokenize()), state);
            state = eq2.state;
        }).not.toThrow();
        // Test toString with different types
        expect(() => {
            const toString1 = (0, typer_1.typeAndDecorate)((0, parser_1.parse)(new lexer_1.Lexer('toString 42').tokenize()), state);
            state = toString1.state;
        }).not.toThrow();
        expect(() => {
            const toString2 = (0, typer_1.typeAndDecorate)((0, parser_1.parse)(new lexer_1.Lexer('toString "hello"').tokenize()), state);
        }).not.toThrow();
    });
    test('list functions should remain polymorphic', () => {
        let state = (0, type_operations_1.createTypeState)();
        state = (0, builtins_1.initializeBuiltins)(state);
        // Test with list of integers (using cons to build lists)
        const list1 = (0, typer_1.typeAndDecorate)((0, parser_1.parse)(new lexer_1.Lexer('cons 1 (cons 2 (cons 3 []))').tokenize()), state);
        state = list1.state;
        // Test toString with different input again - should work  
        expect(() => {
            const toString3 = (0, typer_1.typeAndDecorate)((0, parser_1.parse)(new lexer_1.Lexer('toString 100').tokenize()), state);
        }).not.toThrow();
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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dHlwZV9wb2xsdXRpb24udGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMZXhlciB9IGZyb20gJy4uL3NyYy9sZXhlcic7XG5pbXBvcnQgeyBwYXJzZSB9IGZyb20gJy4uL3NyYy9wYXJzZXIvcGFyc2VyJztcbmltcG9ydCB7IHR5cGVBbmREZWNvcmF0ZSB9IGZyb20gJy4uL3NyYy90eXBlcic7XG5pbXBvcnQgeyBjcmVhdGVUeXBlU3RhdGUgfSBmcm9tICcuLi9zcmMvdHlwZXIvdHlwZS1vcGVyYXRpb25zJztcbmltcG9ydCB7IGluaXRpYWxpemVCdWlsdGlucyB9IGZyb20gJy4uL3NyYy90eXBlci9idWlsdGlucyc7XG5cbmRlc2NyaWJlKCdQb2x5bW9ycGhpYyBGdW5jdGlvbiBUeXBlIFBvbGx1dGlvbicsICgpID0+IHtcblx0dGVzdCgncHJpbnQgc2hvdWxkIHJlbWFpbiBwb2x5bW9ycGhpYyBiZXR3ZWVuIHVzZXMnLCAoKSA9PiB7XG5cdFx0Ly8gSW5pdGlhbGl6ZSBmcmVzaCB0eXBlIHN0YXRlIGZvciBlYWNoIHRlc3Rcblx0XHRsZXQgc3RhdGUgPSBjcmVhdGVUeXBlU3RhdGUoKTtcblx0XHRzdGF0ZSA9IGluaXRpYWxpemVCdWlsdGlucyhzdGF0ZSk7XG5cblx0XHQvLyBGaXJzdCwgdXNlIHByaW50IHdpdGggaW50ZWdlclxuXHRcdGNvbnN0IGxleGVyMSA9IG5ldyBMZXhlcigncHJpbnQgMScpO1xuXHRcdGNvbnN0IHRva2VuczEgPSBsZXhlcjEudG9rZW5pemUoKTtcblx0XHRjb25zdCBwcm9ncmFtMSA9IHBhcnNlKHRva2VuczEpO1xuXG5cdFx0Y29uc3QgcmVzdWx0MSA9IHR5cGVBbmREZWNvcmF0ZShwcm9ncmFtMSwgc3RhdGUpO1xuXHRcdHN0YXRlID0gcmVzdWx0MS5zdGF0ZTtcblx0XHRcblx0XHQvLyBQcmludCBzaG91bGQgd29yayB3aXRoIEludCAtIGNoZWNrIGlmIHRoaXMgc3VjY2VlZHNcblx0XHRleHBlY3QoKCkgPT4gcmVzdWx0MSkubm90LnRvVGhyb3coKTtcblxuXHRcdC8vIE5vdyB1c2UgcHJpbnQgd2l0aCBzdHJpbmcgLSB0aGlzIHNob3VsZCBhbHNvIHdvcmtcblx0XHRjb25zdCBsZXhlcjIgPSBuZXcgTGV4ZXIoJ3ByaW50IFwiaGVsbG9cIicpO1xuXHRcdGNvbnN0IHRva2VuczIgPSBsZXhlcjIudG9rZW5pemUoKTtcblx0XHRjb25zdCBwcm9ncmFtMiA9IHBhcnNlKHRva2VuczIpO1xuXG5cdFx0Ly8gVGhpcyBzaG91bGQgbm90IHRocm93IC0gcHJpbnQgc2hvdWxkIGJlIHBvbHltb3JwaGljXG5cdFx0ZXhwZWN0KCgpID0+IHtcblx0XHRcdGNvbnN0IHJlc3VsdDIgPSB0eXBlQW5kRGVjb3JhdGUocHJvZ3JhbTIsIHN0YXRlKTtcblx0XHR9KS5ub3QudG9UaHJvdygpO1xuXHR9KTtcblxuXHR0ZXN0KCdzaW11bGF0ZSBSRVBMIGJlaGF2aW9yIC0gYWx0ZXJuYXRpbmcgcHJpbnQgdHlwZXMnLCAoKSA9PiB7XG5cdFx0Ly8gU2ltdWxhdGUgUkVQTCBzdGF0ZSBwZXJzaXN0ZW5jZVxuXHRcdGxldCBzdGF0ZSA9IGNyZWF0ZVR5cGVTdGF0ZSgpO1xuXHRcdHN0YXRlID0gaW5pdGlhbGl6ZUJ1aWx0aW5zKHN0YXRlKTtcblxuXHRcdC8vIEZpcnN0IFJFUEwgaW5wdXQ6IHByaW50IDFcblx0XHRjb25zdCBsZXhlcjEgPSBuZXcgTGV4ZXIoJ3ByaW50IDEnKTtcblx0XHRjb25zdCB0b2tlbnMxID0gbGV4ZXIxLnRva2VuaXplKCk7XG5cdFx0Y29uc3QgcHJvZ3JhbTEgPSBwYXJzZSh0b2tlbnMxKTtcblx0XHRjb25zdCByZXN1bHQxID0gdHlwZUFuZERlY29yYXRlKHByb2dyYW0xLCBzdGF0ZSk7XG5cdFx0c3RhdGUgPSByZXN1bHQxLnN0YXRlOyAvLyBQZXJzaXN0IHN0YXRlIGxpa2UgUkVQTCBkb2VzXG5cblx0XHQvLyBTZWNvbmQgUkVQTCBpbnB1dDogcHJpbnQgXCJoaVwiIC0gdGhpcyBzaG91bGQgd29ya1xuXHRcdGNvbnN0IGxleGVyMiA9IG5ldyBMZXhlcigncHJpbnQgXCJoaVwiJyk7XG5cdFx0Y29uc3QgdG9rZW5zMiA9IGxleGVyMi50b2tlbml6ZSgpO1xuXHRcdGNvbnN0IHByb2dyYW0yID0gcGFyc2UodG9rZW5zMik7XG5cdFx0XG5cdFx0Ly8gVGhpcyBpcyB3aGVyZSB0aGUgYnVnIG1hbmlmZXN0cyAtIHByaW50IGdldHMgXCJzdHVja1wiIG9uIEludCB0eXBlXG5cdFx0ZXhwZWN0KCgpID0+IHtcblx0XHRcdGNvbnN0IHJlc3VsdDIgPSB0eXBlQW5kRGVjb3JhdGUocHJvZ3JhbTIsIHN0YXRlKTtcblx0XHRcdHN0YXRlID0gcmVzdWx0Mi5zdGF0ZTtcblx0XHR9KS5ub3QudG9UaHJvdygpO1xuXG5cdFx0Ly8gVGhpcmQgUkVQTCBpbnB1dDogcHJpbnQgNDIgLSBzaG91bGQgd29yayBhZ2FpblxuXHRcdGNvbnN0IGxleGVyMyA9IG5ldyBMZXhlcigncHJpbnQgNDInKTtcblx0XHRjb25zdCB0b2tlbnMzID0gbGV4ZXIzLnRva2VuaXplKCk7XG5cdFx0Y29uc3QgcHJvZ3JhbTMgPSBwYXJzZSh0b2tlbnMzKTtcblx0XHRcblx0XHRleHBlY3QoKCkgPT4ge1xuXHRcdFx0Y29uc3QgcmVzdWx0MyA9IHR5cGVBbmREZWNvcmF0ZShwcm9ncmFtMywgc3RhdGUpO1xuXHRcdH0pLm5vdC50b1Rocm93KCk7XG5cdH0pO1xuXG5cdHRlc3QoJ290aGVyIHBvbHltb3JwaGljIGZ1bmN0aW9ucyBzaG91bGQgbm90IGhhdmUgdHlwZSBwb2xsdXRpb24nLCAoKSA9PiB7XG5cdFx0bGV0IHN0YXRlID0gY3JlYXRlVHlwZVN0YXRlKCk7XG5cdFx0c3RhdGUgPSBpbml0aWFsaXplQnVpbHRpbnMoc3RhdGUpO1xuXG5cdFx0Ly8gVGVzdCA9PSBvcGVyYXRvciB3aXRoIGRpZmZlcmVudCB0eXBlc1xuXHRcdGNvbnN0IGVxMSA9IHR5cGVBbmREZWNvcmF0ZShwYXJzZShuZXcgTGV4ZXIoJzEgPT0gMScpLnRva2VuaXplKCkpLCBzdGF0ZSk7XG5cdFx0c3RhdGUgPSBlcTEuc3RhdGU7XG5cdFx0XG5cdFx0ZXhwZWN0KCgpID0+IHtcblx0XHRcdGNvbnN0IGVxMiA9IHR5cGVBbmREZWNvcmF0ZShwYXJzZShuZXcgTGV4ZXIoJ1wiYVwiID09IFwiYlwiJykudG9rZW5pemUoKSksIHN0YXRlKTtcblx0XHRcdHN0YXRlID0gZXEyLnN0YXRlO1xuXHRcdH0pLm5vdC50b1Rocm93KCk7XG5cblx0XHQvLyBUZXN0IHRvU3RyaW5nIHdpdGggZGlmZmVyZW50IHR5cGVzXG5cdFx0ZXhwZWN0KCgpID0+IHtcblx0XHRcdGNvbnN0IHRvU3RyaW5nMSA9IHR5cGVBbmREZWNvcmF0ZShwYXJzZShuZXcgTGV4ZXIoJ3RvU3RyaW5nIDQyJykudG9rZW5pemUoKSksIHN0YXRlKTtcblx0XHRcdHN0YXRlID0gdG9TdHJpbmcxLnN0YXRlO1xuXHRcdH0pLm5vdC50b1Rocm93KCk7XG5cblx0XHRleHBlY3QoKCkgPT4ge1xuXHRcdFx0Y29uc3QgdG9TdHJpbmcyID0gdHlwZUFuZERlY29yYXRlKHBhcnNlKG5ldyBMZXhlcigndG9TdHJpbmcgXCJoZWxsb1wiJykudG9rZW5pemUoKSksIHN0YXRlKTtcblx0XHR9KS5ub3QudG9UaHJvdygpO1xuXHR9KTtcblxuXHR0ZXN0KCdsaXN0IGZ1bmN0aW9ucyBzaG91bGQgcmVtYWluIHBvbHltb3JwaGljJywgKCkgPT4ge1xuXHRcdGxldCBzdGF0ZSA9IGNyZWF0ZVR5cGVTdGF0ZSgpO1xuXHRcdHN0YXRlID0gaW5pdGlhbGl6ZUJ1aWx0aW5zKHN0YXRlKTtcblxuXHRcdC8vIFRlc3Qgd2l0aCBsaXN0IG9mIGludGVnZXJzICh1c2luZyBjb25zIHRvIGJ1aWxkIGxpc3RzKVxuXHRcdGNvbnN0IGxpc3QxID0gdHlwZUFuZERlY29yYXRlKHBhcnNlKG5ldyBMZXhlcignY29ucyAxIChjb25zIDIgKGNvbnMgMyBbXSkpJykudG9rZW5pemUoKSksIHN0YXRlKTtcblx0XHRzdGF0ZSA9IGxpc3QxLnN0YXRlO1xuXG5cdFx0Ly8gVGVzdCB0b1N0cmluZyB3aXRoIGRpZmZlcmVudCBpbnB1dCBhZ2FpbiAtIHNob3VsZCB3b3JrICBcblx0XHRleHBlY3QoKCkgPT4ge1xuXHRcdFx0Y29uc3QgdG9TdHJpbmczID0gdHlwZUFuZERlY29yYXRlKHBhcnNlKG5ldyBMZXhlcigndG9TdHJpbmcgMTAwJykudG9rZW5pemUoKSksIHN0YXRlKTtcblx0XHR9KS5ub3QudG9UaHJvdygpO1xuXHR9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==