62f96b82b465f10777ef371991519a3e
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const lexer_1 = require("../src/lexer");
const parser_1 = require("../src/parser/parser");
const typer_1 = require("../src/typer");
const evaluator_1 = require("../src/evaluator");
function unwrapValue(val) {
    if (val === null)
        return null;
    if (typeof val !== "object")
        return val;
    switch (val.tag) {
        case "number":
            return val.value;
        case "string":
            return val.value;
        case "constructor":
            if (val.name === "True")
                return true;
            if (val.name === "False")
                return false;
            return { name: val.name, args: val.args.map(unwrapValue) };
        case "list":
            return val.values.map(unwrapValue);
        case "tuple":
            return val.values.map(unwrapValue);
        case "record": {
            const obj = {};
            for (const k in val.fields)
                obj[k] = unwrapValue(val.fields[k]);
            return obj;
        }
        default:
            return val;
    }
}
describe("Option Type Unification Tests", () => {
    let evaluator;
    beforeEach(() => {
        evaluator = new evaluator_1.Evaluator();
    });
    const runCode = (code) => {
        const lexer = new lexer_1.Lexer(code);
        const tokens = lexer.tokenize();
        const ast = (0, parser_1.parse)(tokens);
        const decoratedResult = (0, typer_1.typeAndDecorate)(ast);
        return evaluator.evaluateProgram(decoratedResult.program);
    };
    test("should handle simple Option construction", () => {
        const code = `Some 42`;
        const result = runCode(code);
        const unwrapped = unwrapValue(result.finalResult);
        expect(unwrapped.name).toBe("Some");
        expect(unwrapped.args).toEqual([42]);
    });
    test("should handle None construction", () => {
        const code = `None`;
        const result = runCode(code);
        const unwrapped = unwrapValue(result.finalResult);
        expect(unwrapped.name).toBe("None");
        expect(unwrapped.args).toEqual([]);
    });
    test("should handle Option in conditional expressions", () => {
        // FIXME: Currently fails with "Cannot unify Option a with Option a"
        const code = `
      result = if True then Some 42 else None;
      result
    `;
        const result = runCode(code);
        const unwrapped = unwrapValue(result.finalResult);
        expect(unwrapped.name).toBe("Some");
        expect(unwrapped.args).toEqual([42]);
    });
    test("should handle Option function return types", () => {
        const code = `
      makeOption = fn x => if x > 0 then Some x else None;
      makeOption 5
    `;
        const result = runCode(code);
        const unwrapped = unwrapValue(result.finalResult);
        expect(unwrapped.name).toBe("Some");
        expect(unwrapped.args).toEqual([5]);
    });
    test("should handle safe division function", () => {
        // FIXME: Currently fails with "Cannot unify Option a with Option a"
        const code = `
      safe_divide = fn a b => if b == 0 then None else Some (a / b);
      safe_divide 10 2
    `;
        const result = runCode(code);
        const unwrapped = unwrapValue(result.finalResult);
        expect(unwrapped.name).toBe("Some");
        expect(unwrapped.args).toEqual([5]);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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UUFDcEMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RDLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLHNDQUFzQyxFQUFFLEdBQUcsRUFBRTtRQUNoRCxvRUFBb0U7UUFDcEUsTUFBTSxJQUFJLEdBQUc7OztLQUdaLENBQUM7UUFDRixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0IsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNsRCxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNwQyxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDdEMsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvd29ya3NwYWNlL3Rlc3Qvb3B0aW9uX3VuaWZpY2F0aW9uLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTGV4ZXIgfSBmcm9tIFwiLi4vc3JjL2xleGVyXCI7XG5pbXBvcnQgeyBwYXJzZSB9IGZyb20gXCIuLi9zcmMvcGFyc2VyL3BhcnNlclwiO1xuaW1wb3J0IHsgdHlwZUFuZERlY29yYXRlIH0gZnJvbSBcIi4uL3NyYy90eXBlclwiO1xuaW1wb3J0IHsgRXZhbHVhdG9yLCBWYWx1ZSB9IGZyb20gXCIuLi9zcmMvZXZhbHVhdG9yXCI7XG5cbmZ1bmN0aW9uIHVud3JhcFZhbHVlKHZhbDogVmFsdWUpOiBhbnkge1xuICBpZiAodmFsID09PSBudWxsKSByZXR1cm4gbnVsbDtcbiAgaWYgKHR5cGVvZiB2YWwgIT09IFwib2JqZWN0XCIpIHJldHVybiB2YWw7XG4gIHN3aXRjaCAodmFsLnRhZykge1xuICAgIGNhc2UgXCJudW1iZXJcIjpcbiAgICAgIHJldHVybiB2YWwudmFsdWU7XG4gICAgY2FzZSBcInN0cmluZ1wiOlxuICAgICAgcmV0dXJuIHZhbC52YWx1ZTtcbiAgICBjYXNlIFwiY29uc3RydWN0b3JcIjpcbiAgICAgIGlmICh2YWwubmFtZSA9PT0gXCJUcnVlXCIpIHJldHVybiB0cnVlO1xuICAgICAgaWYgKHZhbC5uYW1lID09PSBcIkZhbHNlXCIpIHJldHVybiBmYWxzZTtcbiAgICAgIHJldHVybiB7IG5hbWU6IHZhbC5uYW1lLCBhcmdzOiB2YWwuYXJncy5tYXAodW53cmFwVmFsdWUpIH07XG4gICAgY2FzZSBcImxpc3RcIjpcbiAgICAgIHJldHVybiB2YWwudmFsdWVzLm1hcCh1bndyYXBWYWx1ZSk7XG4gICAgY2FzZSBcInR1cGxlXCI6XG4gICAgICByZXR1cm4gdmFsLnZhbHVlcy5tYXAodW53cmFwVmFsdWUpO1xuICAgIGNhc2UgXCJyZWNvcmRcIjoge1xuICAgICAgY29uc3Qgb2JqOiBhbnkgPSB7fTtcbiAgICAgIGZvciAoY29uc3QgayBpbiB2YWwuZmllbGRzKSBvYmpba10gPSB1bndyYXBWYWx1ZSh2YWwuZmllbGRzW2tdKTtcbiAgICAgIHJldHVybiBvYmo7XG4gICAgfVxuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gdmFsO1xuICB9XG59XG5cbmRlc2NyaWJlKFwiT3B0aW9uIFR5cGUgVW5pZmljYXRpb24gVGVzdHNcIiwgKCkgPT4ge1xuICBsZXQgZXZhbHVhdG9yOiBFdmFsdWF0b3I7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgZXZhbHVhdG9yID0gbmV3IEV2YWx1YXRvcigpO1xuICB9KTtcblxuICBjb25zdCBydW5Db2RlID0gKGNvZGU6IHN0cmluZykgPT4ge1xuICAgIGNvbnN0IGxleGVyID0gbmV3IExleGVyKGNvZGUpO1xuICAgIGNvbnN0IHRva2VucyA9IGxleGVyLnRva2VuaXplKCk7XG4gICAgY29uc3QgYXN0ID0gcGFyc2UodG9rZW5zKTtcbiAgICBjb25zdCBkZWNvcmF0ZWRSZXN1bHQgPSB0eXBlQW5kRGVjb3JhdGUoYXN0KTtcbiAgICByZXR1cm4gZXZhbHVhdG9yLmV2YWx1YXRlUHJvZ3JhbShkZWNvcmF0ZWRSZXN1bHQucHJvZ3JhbSk7XG4gIH07XG5cbiAgdGVzdChcInNob3VsZCBoYW5kbGUgc2ltcGxlIE9wdGlvbiBjb25zdHJ1Y3Rpb25cIiwgKCkgPT4ge1xuICAgIGNvbnN0IGNvZGUgPSBgU29tZSA0MmA7XG4gICAgY29uc3QgcmVzdWx0ID0gcnVuQ29kZShjb2RlKTtcbiAgICBjb25zdCB1bndyYXBwZWQgPSB1bndyYXBWYWx1ZShyZXN1bHQuZmluYWxSZXN1bHQpO1xuICAgIGV4cGVjdCh1bndyYXBwZWQubmFtZSkudG9CZShcIlNvbWVcIik7XG4gICAgZXhwZWN0KHVud3JhcHBlZC5hcmdzKS50b0VxdWFsKFs0Ml0pO1xuICB9KTtcblxuICB0ZXN0KFwic2hvdWxkIGhhbmRsZSBOb25lIGNvbnN0cnVjdGlvblwiLCAoKSA9PiB7XG4gICAgY29uc3QgY29kZSA9IGBOb25lYDtcbiAgICBjb25zdCByZXN1bHQgPSBydW5Db2RlKGNvZGUpO1xuICAgIGNvbnN0IHVud3JhcHBlZCA9IHVud3JhcFZhbHVlKHJlc3VsdC5maW5hbFJlc3VsdCk7XG4gICAgZXhwZWN0KHVud3JhcHBlZC5uYW1lKS50b0JlKFwiTm9uZVwiKTtcbiAgICBleHBlY3QodW53cmFwcGVkLmFyZ3MpLnRvRXF1YWwoW10pO1xuICB9KTtcblxuICB0ZXN0KFwic2hvdWxkIGhhbmRsZSBPcHRpb24gaW4gY29uZGl0aW9uYWwgZXhwcmVzc2lvbnNcIiwgKCkgPT4ge1xuICAgIC8vIEZJWE1FOiBDdXJyZW50bHkgZmFpbHMgd2l0aCBcIkNhbm5vdCB1bmlmeSBPcHRpb24gYSB3aXRoIE9wdGlvbiBhXCJcbiAgICBjb25zdCBjb2RlID0gYFxuICAgICAgcmVzdWx0ID0gaWYgVHJ1ZSB0aGVuIFNvbWUgNDIgZWxzZSBOb25lO1xuICAgICAgcmVzdWx0XG4gICAgYDtcbiAgICBjb25zdCByZXN1bHQgPSBydW5Db2RlKGNvZGUpO1xuICAgIGNvbnN0IHVud3JhcHBlZCA9IHVud3JhcFZhbHVlKHJlc3VsdC5maW5hbFJlc3VsdCk7XG4gICAgZXhwZWN0KHVud3JhcHBlZC5uYW1lKS50b0JlKFwiU29tZVwiKTtcbiAgICBleHBlY3QodW53cmFwcGVkLmFyZ3MpLnRvRXF1YWwoWzQyXSk7XG4gIH0pO1xuXG4gIHRlc3QoXCJzaG91bGQgaGFuZGxlIE9wdGlvbiBmdW5jdGlvbiByZXR1cm4gdHlwZXNcIiwgKCkgPT4ge1xuICAgIGNvbnN0IGNvZGUgPSBgXG4gICAgICBtYWtlT3B0aW9uID0gZm4geCA9PiBpZiB4ID4gMCB0aGVuIFNvbWUgeCBlbHNlIE5vbmU7XG4gICAgICBtYWtlT3B0aW9uIDVcbiAgICBgO1xuICAgIGNvbnN0IHJlc3VsdCA9IHJ1bkNvZGUoY29kZSk7XG4gICAgY29uc3QgdW53cmFwcGVkID0gdW53cmFwVmFsdWUocmVzdWx0LmZpbmFsUmVzdWx0KTtcbiAgICBleHBlY3QodW53cmFwcGVkLm5hbWUpLnRvQmUoXCJTb21lXCIpO1xuICAgIGV4cGVjdCh1bndyYXBwZWQuYXJncykudG9FcXVhbChbNV0pO1xuICB9KTtcblxuICB0ZXN0KFwic2hvdWxkIGhhbmRsZSBzYWZlIGRpdmlzaW9uIGZ1bmN0aW9uXCIsICgpID0+IHtcbiAgICAvLyBGSVhNRTogQ3VycmVudGx5IGZhaWxzIHdpdGggXCJDYW5ub3QgdW5pZnkgT3B0aW9uIGEgd2l0aCBPcHRpb24gYVwiXG4gICAgY29uc3QgY29kZSA9IGBcbiAgICAgIHNhZmVfZGl2aWRlID0gZm4gYSBiID0+IGlmIGIgPT0gMCB0aGVuIE5vbmUgZWxzZSBTb21lIChhIC8gYik7XG4gICAgICBzYWZlX2RpdmlkZSAxMCAyXG4gICAgYDtcbiAgICBjb25zdCByZXN1bHQgPSBydW5Db2RlKGNvZGUpO1xuICAgIGNvbnN0IHVud3JhcHBlZCA9IHVud3JhcFZhbHVlKHJlc3VsdC5maW5hbFJlc3VsdCk7XG4gICAgZXhwZWN0KHVud3JhcHBlZC5uYW1lKS50b0JlKFwiU29tZVwiKTtcbiAgICBleHBlY3QodW53cmFwcGVkLmFyZ3MpLnRvRXF1YWwoWzVdKTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==